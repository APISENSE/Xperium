<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="/libs/leaflet-0.7.2/leaflet.css" />
		<style type="text/css">
			#map{height:600px;}
		</style>
	</head>
	<body onload="initmap();">
	    <div id="map"></div>
		<script src="/libs/leaflet-0.7.2/leaflet.js"></script>
		<script src="/libs/leaflet.polylineDecorator.min.js"></script>
		<script type="text/javascript">
			var map;
			var ajaxRequest;
			var plotlist;
			var plotlayers = [];

			function initmap() {
				// set up the map
				map = new L.Map('map');

				// create the tile layer with correct attribution
				var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
				var osmAttrib='Map data Â© OpenStreetMap contributors';
				var osm = new L.TileLayer(osmUrl, {minZoom: 8, maxZoom: 20, attribution: osmAttrib});		

				// start the map in South-East England
				map.setView(new L.LatLng(50.6372, 3.0633), 12);
				map.addLayer(osm);

				addMarkers();
			}
			
			function addMarkers() {
			<%
				data.forEach(function(ride) {
					// Choose the color of the path according of the speed
					var color = 'blue';
					var averageSpeed = ride.computeAverageSpeed();
					if(averageSpeed > 50) {
						color = 'red';
					} else if(averageSpeed < 4) {
						color = 'green';
					}
					
					// Build an array of coordinates to polyline()
					var coordinates = ride.getCoordinates();
					var latLonArray = [];
			
					/*
					 * Build a array of all position and make markers 
					 * to give some information about the current position (speed, etc.)
					 */
					coordinates.forEach(function(coord, index) {
						var curCoord = [coord.latitude, coord.longitude];
						
						// Array construction
						latLonArray.push(curCoord);
						
						// Compute informations
						var curSpeed = 'unknown';
						if(index > 0) {
							curSpeed = coordinates[index - 1].speed(coordinates[index]).toFixed(1);
						}
						
						// Adds a marker for each coordinate
						%>
						L.marker(<%= JSON.stringify(curCoord) %>).addTo(map)
							.bindPopup('Speed: <%= curSpeed %> km/h');
						<%
					});
					
					// Draws the entire path from the previous array
					%>
					L.polyline(<%= JSON.stringify(latLonArray) %>, {color: '<%= color %>'}).addTo(map)
				   		.bindPopup('Average speed: <%= averageSpeed %> km/h<br>Total distance: <%= ride.computeTotalDistance().toFixed(1) %> km');
				    <%
				});
			%>
			}
			
		</script>
	</body>
</html>
